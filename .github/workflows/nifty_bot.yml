name: Nifty Iron Condor Signal Bot

on:
  schedule:
    - cron: '55 3 * * 1-5'
    - cron: '0 4 * * 1-5'
    - cron: '10 4 * * 1-5'
    - cron: '20 4 * * 1-5'
    - cron: '30 4 * * 1-5'
    - cron: '40 4 * * 1-5'
    - cron: '50 4 * * 1-5'
    - cron: '0 5 * * 1-5'
    - cron: '10 5 * * 1-5'
    - cron: '20 5 * * 1-5'
    - cron: '30 5 * * 1-5'
    - cron: '40 5 * * 1-5'
    - cron: '50 5 * * 1-5'
    - cron: '0 6 * * 1-5'
    - cron: '10 6 * * 1-5'
    - cron: '20 6 * * 1-5'
    - cron: '30 6 * * 1-5'
    - cron: '40 6 * * 1-5'
    - cron: '50 6 * * 1-5'
    - cron: '0 7 * * 1-5'
    - cron: '10 7 * * 1-5'
    - cron: '20 7 * * 1-5'
    - cron: '30 7 * * 1-5'
    - cron: '40 7 * * 1-5'
    - cron: '45 9 * * 1-5'

  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'debug'
        type: choice
        options:
          - entry
          - exit
          - test
          - tgtest
          - debug

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine run mode
        id: mode
        run: |
          HOUR=$(date -u +%H)
          MIN=$(date -u +%M)
          INPUT_MODE="${{ github.event.inputs.mode }}"
          if [ "$INPUT_MODE" != "" ]; then
            echo "mode=$INPUT_MODE" >> $GITHUB_OUTPUT
          elif [ "$HOUR" = "03" ] && [ "$MIN" = "55" ]; then
            echo "mode=entry" >> $GITHUB_OUTPUT
          else
            echo "mode=exit" >> $GITHUB_OUTPUT
          fi

      - name: Run bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        working-directory: src
        run: |
          MODE="${{ steps.mode.outputs.mode }}"
          echo "Running in mode: $MODE"
          if [ "$MODE" = "debug" ]; then
            python debug.py
          else
            python main.py $MODE
          fi
