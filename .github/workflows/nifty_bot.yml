# .github/workflows/nifty_bot.yml
# ─────────────────────────────────────────────────────────────
#  FREE hosting via GitHub Actions
#  Runs entry signal at 9:25 AM IST (= 3:55 AM UTC)
#  Runs exit checks every 5 min from 9:30 AM to 3:20 PM IST
# ─────────────────────────────────────────────────────────────

name: Nifty Iron Condor Signal Bot

on:
  schedule:
    # ── Entry signal ──────────────────────────────────────────
    # 9:25 AM IST = 03:55 AM UTC  (Mon–Fri only)
    - cron: '55 3 * * 1-5'

    # ── Exit checks every 5 min from 9:30 to 15:15 IST ───────
    # 9:30  IST = 04:00 UTC
    - cron: '0 4 * * 1-5'
    - cron: '5 4 * * 1-5'
    - cron: '10 4 * * 1-5'
    - cron: '15 4 * * 1-5'
    - cron: '20 4 * * 1-5'
    - cron: '25 4 * * 1-5'
    - cron: '30 4 * * 1-5'
    - cron: '35 4 * * 1-5'
    - cron: '40 4 * * 1-5'
    - cron: '45 4 * * 1-5'
    - cron: '50 4 * * 1-5'
    - cron: '55 4 * * 1-5'
    - cron: '0 5 * * 1-5'
    - cron: '5 5 * * 1-5'
    - cron: '10 5 * * 1-5'
    - cron: '15 5 * * 1-5'
    - cron: '20 5 * * 1-5'
    - cron: '25 5 * * 1-5'
    - cron: '30 5 * * 1-5'
    - cron: '35 5 * * 1-5'
    - cron: '40 5 * * 1-5'
    - cron: '45 5 * * 1-5'
    - cron: '50 5 * * 1-5'
    - cron: '55 5 * * 1-5'
    - cron: '0 6 * * 1-5'
    - cron: '5 6 * * 1-5'
    - cron: '10 6 * * 1-5'
    - cron: '15 6 * * 1-5'
    - cron: '20 6 * * 1-5'
    - cron: '25 6 * * 1-5'
    - cron: '30 6 * * 1-5'
    - cron: '35 6 * * 1-5'
    - cron: '40 6 * * 1-5'
    - cron: '45 6 * * 1-5'
    # 3:15 PM IST = 09:45 UTC  (final force exit)
    - cron: '45 9 * * 1-5'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'entry'
        type: choice
        options: [entry, exit, test]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine run mode
        id: mode
        run: |
          # 9:25 AM IST = 03:55 UTC → entry mode
          # All other times → exit mode
          HOUR=$(date -u +%H)
          MIN=$(date -u +%M)
          if [ "$HOUR" = "03" ] && [ "$MIN" = "55" ]; then
            echo "mode=entry" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.mode }}" != "" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            echo "mode=exit" >> $GITHUB_OUTPUT
          fi

      - name: Run bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        working-directory: src
        run: python main.py ${{ steps.mode.outputs.mode }}
